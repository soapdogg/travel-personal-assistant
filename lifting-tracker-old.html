<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lifting Progress Tracker</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1600.0.min.js"></script>
    <script src="config.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 10px;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #e0e0e0;
        }
        .container {
            background: #2d2d44;
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        
        /* Mobile Responsive Design */
        @media (max-width: 768px) {
            body {
                padding: 5px;
            }
            .container {
                padding: 10px;
                border-radius: 10px;
            }
            h1 {
                font-size: 1.8em !important;
                margin-bottom: 20px !important;
            }
            .tab {
                min-width: 120px !important;
                padding: 10px !important;
                font-size: 14px !important;
            }
            .exercise-card {
                padding: 15px !important;
            }
            .day-section {
                padding: 15px !important;
            }
            .input-section {
                padding: 15px !important;
            }
            .chart-container {
                padding: 10px !important;
                height: 250px !important;
            }
            .progress-stats {
                grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)) !important;
                gap: 8px !important;
            }
            .stat-box {
                padding: 8px !important;
            }
            .stat-value {
                font-size: 1.1em !important;
            }
            .set-input {
                flex-wrap: nowrap !important;
                gap: 4px !important;
                font-size: 12px !important;
            }
            .set-input span {
                font-size: 11px !important;
                white-space: nowrap !important;
            }
            .set-input input {
                width: 60px !important;
                font-size: 12px !important;
            }
            .btn {
                padding: 6px 12px !important;
                font-size: 12px !important;
            }
            .btn-primary {
                padding: 10px 16px !important;
                font-size: 14px !important;
            }
            select {
                min-width: 120px !important;
                font-size: 12px !important;
            }
        }
        h1 {
            text-align: center;
            color: #64ffda;
            margin-bottom: 30px;
            font-size: 2.5em;
        }
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            flex-wrap: wrap;
        }
        .tab {
            flex: 1;
            padding: 15px;
            background: #3d3d5c;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            min-width: 200px;
            color: #e0e0e0;
        }
        .tab.active {
            background: linear-gradient(45deg, #64ffda, #00bcd4);
            color: #1a1a2e;
        }
        .tab:hover:not(.active) {
            background: #4a4a6a;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .day-section {
            background: #353553;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border-left: 5px solid #64ffda;
        }
        .day-title {
            font-size: 2em;
            font-weight: bold;
            color: #64ffda;
            margin-bottom: 25px;
            text-align: center;
        }
        .exercises-grid {
            display: flex;
            flex-direction: column;
            gap: 30px;
            margin-bottom: 30px;
        }
        .exercise-card {
            background: #3d3d5c;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            border-top: 4px solid #ff6b6b;
        }
        .exercise-title {
            font-size: 1.4em;
            font-weight: bold;
            color: #64ffda;
            margin-bottom: 15px;
        }
        .chart-container {
            background: #2a2a42;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            height: 300px;
            position: relative;
        }
        .progress-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }
        .stat-box {
            background: #4a4a6a;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-value {
            font-size: 1.3em;
            font-weight: bold;
            color: #ff6b6b;
        }
        .stat-label {
            color: #b0b0b0;
            font-size: 0.85em;
            margin-top: 4px;
        }
        .input-section {
            background: #3d3d5c;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            border-left: 5px solid #ffd54f;
        }
        .input-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #ffd54f;
            margin-bottom: 15px;
        }
        .workout-input {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 20px;
        }
        .exercise-input {
            background: #2a2a42;
            border-radius: 8px;
            padding: 15px;
            border: 2px solid #ffd54f;
        }
        .exercise-input h4 {
            margin: 0 0 10px 0;
            color: #ffd54f;
        }
        .sets-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .set-input {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }
        .set-input input {
            padding: 8px 12px;
            border: 1px solid #555;
            border-radius: 6px;
            width: 70px;
            font-size: 14px;
            background: #1a1a2e;
            color: #e0e0e0;
        }
        .set-input input:focus {
            outline: none;
            border-color: #64ffda;
            box-shadow: 0 0 0 2px rgba(100, 255, 218, 0.2);
        }
        .btn {
            background: linear-gradient(45deg, #64ffda, #4fc3f7);
            color: #1a1a2e;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s ease;
            margin: 4px;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(100, 255, 218, 0.3);
        }
        .btn-primary {
            background: linear-gradient(45deg, #64ffda, #00bcd4);
            padding: 15px 30px;
            font-size: 16px;
            margin: 15px 10px;
        }
        .history-section {
            background: #3d3d5c;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            border-left: 5px solid #64ffda;
        }
        .history-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #64ffda;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .history-entries {
            max-height: 300px;
            overflow-y: auto;
        }
        .history-entry {
            background: #2a2a42;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #555;
        }
        .history-entry:hover {
            background: #333351;
        }
        .history-date {
            font-weight: bold;
            color: #64ffda;
        }
        .history-sets {
            color: #b0b0b0;
            font-size: 0.9em;
        }
        .btn-delete {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 4px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        .btn-delete:hover {
            background: #ff5252;
        }
        .date-input {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .date-input input[type="date"] {
            padding: 8px 12px;
            border: 2px solid #555;
            border-radius: 5px;
            font-size: 14px;
            background: #1a1a2e;
            color: #e0e0e0;
        }
        .auxiliary-section {
            background: #e8f5e8;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            border-left: 5px solid #27ae60;
        }
        .auxiliary-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #1e7e34;
            margin-bottom: 15px;
        }
        .auxiliary-exercises {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        .aux-exercise {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #27ae60;
        }
        .aux-exercise strong {
            color: #1e7e34;
        }
        .data-management {
            background: #3d3d5c;
            border-radius: 12px;
            padding: 20px;
            margin-top: 30px;
            border-left: 5px solid #64ffda;
            text-align: center;
        }
        .data-management h3 {
            color: #64ffda;
            margin-bottom: 15px;
        }
        select {
            padding: 8px 12px;
            border: 2px solid #555;
            border-radius: 5px;
            font-size: 14px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a2e;
            color: #e0e0e0;
            font-weight: 500;
            cursor: pointer;
            transition: border-color 0.3s ease;
            min-width: 150px;
        }
        select:hover {
            border-color: #64ffda;
        }
        select:focus {
            outline: none;
            border-color: #64ffda;
            box-shadow: 0 0 0 3px rgba(100, 255, 218, 0.2);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>💪 Lifting Progress Tracker</h1>
        
        <div id="userInfo" style="
            display: none; background: #1a1a2e; padding: 10px; border-radius: 8px; margin-bottom: 20px;
            justify-content: space-between; align-items: center;
        ">
            <span style="color: #64ffda;">
                👤 Welcome, <span id="currentUsername"></span>
            </span>
            <button onclick="logout()" style="
                background: #e74c3c; color: white; border: none; padding: 6px 12px; 
                border-radius: 5px; cursor: pointer; font-size: 14px;
            ">Logout</button>
        </div>
    
        <div id="day1" class="tab-content active">
            <div class="day-section">
                <div class="input-section">
                    <div class="input-title">📝 Log New Session</div>
                    
                    <div class="date-input">
                        <label><strong>Date:</strong></label>
                        <input type="date" id="day1-date" />
                        <span style="color: #b0b0b0; font-size: 0.9em;">(Leave blank for today)</span>
                    </div>

                    <button class="btn" onclick="addExerciseToContainer('workout-input-1')">+ Add Exercise</button>
                    <div class="workout-input" id="workout-input-1">
                        <div class="exercise-input">
                            <div class="exercise-title" id="exercise-title-workout-1"></div>
                            <div id="rep-ranges-1" style="margin-bottom: 10px; font-size: 14px; color: #b0b0b0; font-style: italic;"></div>
                            <div id="exercise-history-1" style="margin-bottom: 15px;"></div>
                            <div style="margin-bottom: 10px;">
                                <button class="btn" onclick="getAIRecommendations(1)" style="background: linear-gradient(45deg, #ff6b6b, #ffa726); color: white; font-size: 12px; padding: 6px 12px;">🤖 AI Recommendations</button>
                                <button class="btn" onclick="testMobileConnection()" style="background: #666; color: white; font-size: 11px; padding: 4px 8px; margin-left: 5px;">🧪 Test Connection</button>
                                <span id="ai-loading-1" style="display: none; margin-left: 10px; color: #64ffda; font-size: 12px;">Analyzing your data...</span>
                            </div>
                            <div id="ai-recommendations-1" style="margin-bottom: 10px; display: none;"></div>
                            <div class="sets-container" id="exercise-sets-1">
                                <div class="set-input">
                                    <input type="number" inputmode="numeric" pattern="[0-9]*" placeholder="Weight" />
                                    <span>&times;</span>
                                    <input type="number" inputmode="numeric" pattern="[0-9]*" placeholder="Reps" />
                                </div>
                                <div class="set-input">
                                    <input type="number" inputmode="numeric" pattern="[0-9]*" placeholder="Weight" />
                                    <span>&times;</span>
                                    <input type="number" inputmode="numeric" pattern="[0-9]*" placeholder="Reps" />
                                    <button class="btn" onclick="this.parentElement.remove()" style="padding: 4px 8px; margin-left: 8px;">&times;</button>
                                </div>
                                <div class="set-input">
                                    <input type="number" inputmode="numeric" pattern="[0-9]*" placeholder="Weight" />
                                    <span>&times;</span>
                                    <input type="number" inputmode="numeric" pattern="[0-9]*" placeholder="Reps" />
                                    <button class="btn" onclick="this.parentElement.remove()" style="padding: 4px 8px; margin-left: 8px;">&times;</button>
                                </div>
                            </div>
                            <button class="btn" onclick="addSetToContainer('exercise-sets-1')">+ Add Set</button>
                        </div>
                    </div>

                    <div style="text-align: center;">
                        <button class="btn btn-primary" onclick="saveDay1Session()">💾 Save Session</button>
                    </div>
                </div>

                <div class="exercises-grid">
                    <div class="exercise-card">
                        <div class="exercise-title" id="exercise-title-chart"></div>
                        
                        <div class="progress-stats">
                            <div class="stat-box">
                                <div class="stat-value" id="current-max">0</div>
                                <div class="stat-label">1RM Max</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-value" id="total-gain">0</div>
                                <div class="stat-label">Total Gain</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-value" id="sessions">0</div>
                                <div class="stat-label">Sessions</div>
                            </div>
                        </div>

                        <div class="chart-container">
                            <h5 style="margin: 0 0 10px 0; color: #2c3e50;">1RM Progression</h5>
                            <canvas id="deadlift1RMChart"></canvas>
                        </div>
                        
                        <div class="chart-container">
                            <h5 style="margin: 0 0 10px 0; color: #2c3e50;">Volume Per Session</h5>
                            <canvas id="deadliftVolumeChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="history-section">
                    <div class="history-title">
                        <span>📜 Session History</span>
                        <button class="btn" onclick="toggleHistory('day1')">Show/Hide</button>
                    </div>
                    <div id="history" class="history-entries" style="display: none;">
                        <!-- History will be populated here -->
                    </div>
                </div>
                
            </div>
        </div>

        <!-- Data Management Section -->
        <div class="data-management">
            <h3>📊 Data Management</h3>
            <button class="btn btn-primary" onclick="exportData()">📥 Export All Data</button>
        </div>
    </div>

    <script src="config.js"></script>
    <script>
        // AWS DynamoDB Configuration - SECURE SETUP
        // 
        // IMPORTANT: For production security, create a separate config.js file
        // that you DON'T commit to version control, or use Netlify Functions
        // 
        // TEMPORARY SECURE SETUP:
        // 1. Create a file called 'config.js' with:
        //    window.APP_CONFIG = {
        //        accessKeyId: 'your_key_here',
        //        secretAccessKey: 'your_secret_here', 
        //        region: 'us-west-2',
        //        tableName: 'lifting-tracker-workouts',
        //        password: 'your_password_here'
        //    };
        // 2. Add <script src="config.js"><
        // /script> before this script
        // 3. Add config.js to your .gitignore
        //
        // Configuration with fallbacks
        const AWS_CONFIG = {
            accessKeyId: (window.APP_CONFIG && window.APP_CONFIG.accessKeyId) || '', 
            secretAccessKey: (window.APP_CONFIG && window.APP_CONFIG.secretAccessKey) || '', 
            region: (window.APP_CONFIG && window.APP_CONFIG.region) || 'us-west-2',
            tableName: (window.APP_CONFIG && window.APP_CONFIG.tableName) || 'lifting-tracker-workouts',
            usersTableName: (window.APP_CONFIG && window.APP_CONFIG.usersTableName) || 'lifting-tracker-users'
        };
        
        const ADMIN_PASSWORD = (window.APP_CONFIG && window.APP_CONFIG.adminPassword) || 'AdminSetup123!';
        
        // Current user state
        let currentUser = null;

        // Debug logging
        console.log('Config loaded:', {
            hasConfig: !!window.APP_CONFIG,
            hasAccessKey: !!AWS_CONFIG.accessKeyId,
            multiUserMode: true
        });

        // Initialize AWS SDK variables
        let dynamodb = null;
        let USE_DATABASE = AWS_CONFIG.accessKeyId && AWS_CONFIG.accessKeyId.length > 0;

        async function initializeAWS() {
            if (USE_DATABASE) {
                try {
                    console.log('Initializing AWS SDK...');
                    console.log('AWS object:', typeof AWS);
                    
                    if (typeof AWS === 'undefined') {
                        console.error('AWS SDK not loaded');
                        USE_DATABASE = false;
                        return;
                    }
                    
                    AWS.config.update({
                        accessKeyId: AWS_CONFIG.accessKeyId,
                        secretAccessKey: AWS_CONFIG.secretAccessKey,
                        region: AWS_CONFIG.region
                    });
                    
                    dynamodb = new AWS.DynamoDB.DocumentClient();
                    console.log('AWS DynamoDB DocumentClient initialized successfully');
                    
                    // Ensure users table exists
                    await ensureUsersTableExists();
                } catch (error) {
                    console.error('Error initializing AWS:', error);
                    USE_DATABASE = false;
                }
            }
        }

        // Ensure users table exists
        async function ensureUsersTableExists() {
            try {
                const dynamodbService = new AWS.DynamoDB();
                
                const params = {
                    TableName: AWS_CONFIG.usersTableName,
                    KeySchema: [
                        { AttributeName: 'username', KeyType: 'HASH' }
                    ],
                    AttributeDefinitions: [
                        { AttributeName: 'username', AttributeType: 'S' }
                    ],
                    BillingMode: 'PAY_PER_REQUEST'
                };

                try {
                    await dynamodbService.describeTable({ TableName: AWS_CONFIG.usersTableName }).promise();
                    console.log('Users table already exists');
                } catch (error) {
                    if (error.code === 'ResourceNotFoundException') {
                        console.log('Creating users table...');
                        await dynamodbService.createTable(params).promise();
                        
                        // Wait for table to be active
                        await dynamodbService.waitFor('tableExists', { TableName: AWS_CONFIG.usersTableName }).promise();
                        console.log('Users table created successfully');
                    } else {
                        throw error;
                    }
                }

                // Create default user if needed
                await createDefaultUserIfNeeded();
            } catch (error) {
                console.error('Error ensuring users table exists:', error);
            }
        }

        // Create default user if needed
        async function createDefaultUserIfNeeded() {
            try {
                const defaultUsername = 'soppi';
                const defaultPassword = 'lifting123';
                
                // Check if default user already exists
                const existingUserParams = {
                    TableName: AWS_CONFIG.usersTableName,
                    Key: {
                        username: defaultUsername
                    }
                };

                const existingUser = await dynamodb.get(existingUserParams).promise();
                
                if (!existingUser.Item) {
                    // Create default user
                    console.log('Creating default user account...');
                    const hashedPassword = await hashPassword(defaultPassword);
                    
                    const createUserParams = {
                        TableName: AWS_CONFIG.usersTableName,
                        Item: {
                            username: defaultUsername,
                            password: hashedPassword,
                            created_at: new Date().toISOString()
                        }
                    };

                    await dynamodb.put(createUserParams).promise();
                    console.log(`✅ Default user created!`);
                    console.log(`Username: ${defaultUsername}`);
                    console.log(`Password: ${defaultPassword}`);
                } else {
                    console.log('Default user already exists');
                }
                
            } catch (error) {
                console.error('Error creating default user:', error);
            }
        }

        var workouts = [
            { exercise: 'deadlift', date: '2025-05-26', sets: [{weight: 365, reps: 2}, {weight: 335, reps: 4}, {weight: 315, reps: 5}]},
            { exercise: 'deadlift', date: '2025-06-02', sets: [{weight: 365, reps: 3}, {weight: 335, reps: 4}, {weight: 315, reps: 4}]},
            { exercise: 'deadlift', date: '2025-06-09', sets: [{weight: 365, reps: 4}, {weight: 335, reps: 5}, {weight: 315, reps: 6}]},
            { exercise: 'deadlift', date: '2025-06-16', sets: [{weight: 375, reps: 2}, {weight: 345, reps: 3}, {weight: 325, reps: 4}]},

            { exercise: 'military', date: '2025-05-26', sets: [{weight: 120, reps: 5}, {weight: 110, reps: 6}, {weight: 100, reps: 7}]},
            { exercise: 'military', date: '2025-06-02', sets: [{weight: 125, reps: 5}, {weight: 115, reps: 6}, {weight: 105, reps: 7}]},
            { exercise: 'military', date: '2025-06-09', sets: [{weight: 130, reps: 5}, {weight: 120, reps: 6}, {weight: 110, reps: 7}]},
            { exercise: 'military', date: '2025-06-16', sets: [{weight: 135, reps: 5}, {weight: 125, reps: 6}, {weight: 115, reps: 7}]},
    
            { exercise: 'bench', date: '2025-05-28', sets: [{weight: 205, reps: 5}, {weight: 195, reps: 6}, {weight: 185, reps: 7}]},
            { exercise: 'bench', date: '2025-06-04', sets: [{weight: 210, reps: 5}, {weight: 200, reps: 6}, {weight: 190, reps: 7}]},
            { exercise: 'bench', date: '2025-06-11', sets: [{weight: 215, reps: 5}, {weight: 205, reps: 6}, {weight: 195, reps: 7}]},
            { exercise: 'bench', date: '2025-06-18', sets: [{weight: 225, reps: 5}, {weight: 205, reps: 6}, {weight: 185, reps: 7}]},

            { exercise: 'powerclean', date: '2025-05-28', sets: [{weight: 135, reps: 5}, {weight: 135, reps: 5}, {weight: 135, reps: 5}]},
            { exercise: 'powerclean', date: '2025-06-04', sets: [{weight: 135, reps: 5}, {weight: 135, reps: 5}, {weight: 135, reps: 5}]},
            { exercise: 'powerclean', date: '2025-06-11', sets: [{weight: 135, reps: 5}, {weight: 135, reps: 5}, {weight: 135, reps: 5}]},
            { exercise: 'powerclean', date: '2025-06-18', sets: [{weight: 140, reps: 5}, {weight: 140, reps: 5}, {weight: 140, reps: 5}]},
            
            { exercise: 'squat', date: '2025-05-30', sets: [{weight: 255, reps: 4}, {weight: 245, reps: 5}, {weight: 225, reps: 6}]},
            { exercise: 'squat', date: '2025-06-06', sets: [{weight: 255, reps: 5}, {weight: 245, reps: 6}, {weight: 225, reps: 7}]},
            { exercise: 'squat', date: '2025-06-13', sets: [{weight: 265, reps: 3}, {weight: 245, reps: 5}, {weight: 225, reps: 7}]},
            { exercise: 'squat', date: '2025-06-20', sets: [{weight: 265, reps: 2}, {weight: 245, reps: 5}, {weight: 225, reps: 7}]},
         
            { exercise: 'pullup', date: '2025-05-30', sets: [{weight: 215, reps: 5}, {weight: 200, reps: 6}, {weight: 185, reps: 7}]},
            { exercise: 'pullup', date: '2025-06-06', sets: [{weight: 220, reps: 5}, {weight: 205, reps: 6}, {weight: 185, reps: 7}]},
            { exercise: 'pullup', date: '2025-06-13', sets: [{weight: 225, reps: 5}, {weight: 210, reps: 6}, {weight: 195, reps: 7}]},
            { exercise: 'pullup', date: '2025-06-20', sets: [{weight: 225, reps: 5}, {weight: 210, reps: 6}, {weight: 195, reps: 7}]}
        ];

        var exercises = [
            // Compound Movements
            { key: 'deadlift', displayName: 'Deadlift', repRanges: '2-5', primaryMuscles: ['Hamstrings', 'Glutes'], secondaryMuscles: ['Lower Back', 'Lats', 'Traps', 'Forearms'] },
            { key: 'squat', displayName: 'Back Squat', repRanges: '3-6', primaryMuscles: ['Quadriceps', 'Glutes'], secondaryMuscles: ['Hamstrings', 'Calves', 'Core'] },
            { key: 'bench', displayName: 'Bench Press', repRanges: '5-8', primaryMuscles: ['Chest'], secondaryMuscles: ['Shoulders', 'Triceps'] },
            { key: 'military', displayName: 'Military Press', repRanges: '5-8', primaryMuscles: ['Shoulders'], secondaryMuscles: ['Triceps', 'Core', 'Upper Back'] },
            { key: 'powerclean', displayName: 'Power Clean', repRanges: '2-5', primaryMuscles: ['Full Body'], secondaryMuscles: ['Power', 'Coordination'] },
            { key: 'pullup', displayName: 'Pull-ups', repRanges: '5-8', primaryMuscles: ['Lats'], secondaryMuscles: ['Biceps', 'Rear Delts', 'Rhomboids'] },
            
            // Upper Body Push
            { key: 'inclinebench', displayName: 'Incline Bench Press', repRanges: '6-10', primaryMuscles: ['Upper Chest'], secondaryMuscles: ['Shoulders', 'Triceps'] },
            { key: 'dumbellpress', displayName: 'Dumbbell Press', repRanges: '8-12', primaryMuscles: ['Chest'], secondaryMuscles: ['Shoulders', 'Triceps'] },
            { key: 'shoulderpress', displayName: 'Dumbbell Shoulder Press', repRanges: '8-12', primaryMuscles: ['Shoulders'], secondaryMuscles: ['Triceps', 'Core'] },
            { key: 'lateralraise', displayName: 'Lateral Raise', repRanges: '12-15', primaryMuscles: ['Side Delts'], secondaryMuscles: ['Traps'] },
            { key: 'triceps', displayName: 'Tricep Dips', repRanges: '8-12', primaryMuscles: ['Triceps'], secondaryMuscles: ['Chest', 'Shoulders'] },
            { key: 'tricepext', displayName: 'Tricep Extension', repRanges: '10-15', primaryMuscles: ['Triceps'], secondaryMuscles: [] },
            
            // Upper Body Pull

            { key: 'chinup', displayName: 'Chin-ups', repRanges: '5-8', primaryMuscles: ['Lats', 'Biceps'], secondaryMuscles: ['Rear Delts', 'Rhomboids'] },
            { key: 'bentrow', displayName: 'Bent Over Row', repRanges: '6-10', primaryMuscles: ['Lats', 'Rhomboids'], secondaryMuscles: ['Rear Delts', 'Biceps'] },
            { key: 'tbarrow', displayName: 'T-Bar Row', repRanges: '8-12', primaryMuscles: ['Lats', 'Rhomboids'], secondaryMuscles: ['Rear Delts', 'Biceps'] },
            { key: 'cablerow', displayName: 'Cable Row', repRanges: '10-15', primaryMuscles: ['Lats', 'Rhomboids'], secondaryMuscles: ['Rear Delts', 'Biceps'] },
            { key: 'biceps', displayName: 'Bicep Curls', repRanges: '10-15', primaryMuscles: ['Biceps'], secondaryMuscles: ['Forearms'] },
            { key: 'hammercurl', displayName: 'Hammer Curls', repRanges: '10-15', primaryMuscles: ['Biceps', 'Forearms'], secondaryMuscles: [] },
            { key: 'facepull', displayName: 'Face Pulls', repRanges: '12-20', primaryMuscles: ['Rear Delts'], secondaryMuscles: ['Rhomboids', 'Traps'] },
            
            // Lower Body
            { key: 'lunges', displayName: 'Lunges', repRanges: '10-15', primaryMuscles: ['Quadriceps', 'Glutes'], secondaryMuscles: ['Hamstrings', 'Calves'] },
            { key: 'legcurl', displayName: 'Leg Curls', repRanges: '12-15', primaryMuscles: ['Hamstrings'], secondaryMuscles: ['Glutes'] },
            { key: 'legextension', displayName: 'Leg Extension', repRanges: '12-15', primaryMuscles: ['Quadriceps'], secondaryMuscles: [] },
            { key: 'calfraize', displayName: 'Calf Raises', repRanges: '15-20', primaryMuscles: ['Calves'], secondaryMuscles: [] },
            { key: 'romaniandeadlift', displayName: 'Romanian Deadlift', repRanges: '8-12', primaryMuscles: ['Hamstrings', 'Glutes'], secondaryMuscles: ['Lower Back'] },
            { key: 'hipthrust', displayName: 'Hip Thrust', repRanges: '10-15', primaryMuscles: ['Glutes'], secondaryMuscles: ['Hamstrings'] },
            
            // Core & Functional
            { key: 'plank', displayName: 'Plank Hold', repRanges: '30-60s', primaryMuscles: ['Core'], secondaryMuscles: ['Shoulders', 'Back'] },
            { key: 'russian', displayName: 'Russian Twists', repRanges: '20-30', primaryMuscles: ['Obliques'], secondaryMuscles: ['Core'] },
            { key: 'mountainclimber', displayName: 'Mountain Climbers', repRanges: '20-30', primaryMuscles: ['Core'], secondaryMuscles: ['Shoulders', 'Legs'] },
            { key: 'burpees', displayName: 'Burpees', repRanges: '8-15', primaryMuscles: ['Full Body'], secondaryMuscles: ['Cardio'] },
        ]

        var charts = {};

        // Multi-user authentication system
        async function checkAuthentication() {
            // Check if already authenticated in this session
            const storedUser = sessionStorage.getItem('currentUser');
            if (storedUser) {
                currentUser = JSON.parse(storedUser);
                return true;
            }

            // Show login/register modal
            return await showLoginModal();
        }

        async function showLoginModal() {
            // Create modal HTML
            const modalHtml = `
                <div id="authModal" style="
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                    background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center;
                    z-index: 1000;
                ">
                    <div style="
                        background: #2d2d44; padding: 30px; border-radius: 15px; width: 90%; max-width: 400px;
                        box-shadow: 0 10px 30px rgba(0,0,0,0.5);
                    ">
                        <h2 style="color: #64ffda; text-align: center; margin-bottom: 20px;">💪 Lifting Tracker</h2>
                        
                        <div id="loginForm">
                            <h3 style="color: #e0e0e0; margin-bottom: 15px;">Login</h3>
                            <input type="text" id="loginUsername" placeholder="Username" style="
                                width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #555;
                                border-radius: 5px; background: #1a1a2e; color: #e0e0e0; box-sizing: border-box;
                            ">
                            <input type="password" id="loginPassword" placeholder="Password" style="
                                width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #555;
                                border-radius: 5px; background: #1a1a2e; color: #e0e0e0; box-sizing: border-box;
                            ">
                            <button onclick="attemptLogin()" style="
                                width: 100%; padding: 12px; background: linear-gradient(45deg, #64ffda, #00bcd4);
                                color: #1a1a2e; border: none; border-radius: 5px; font-weight: bold; cursor: pointer;
                                margin-bottom: 10px;
                            ">Login</button>
                            <button onclick="showRegisterForm()" style="
                                width: 100%; padding: 10px; background: transparent; color: #64ffda;
                                border: 1px solid #64ffda; border-radius: 5px; cursor: pointer;
                            ">Create New Account</button>
                        </div>

                        <div id="registerForm" style="display: none;">
                            <h3 style="color: #e0e0e0; margin-bottom: 15px;">Create Account</h3>
                            <input type="text" id="registerUsername" placeholder="Choose Username" style="
                                width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #555;
                                border-radius: 5px; background: #1a1a2e; color: #e0e0e0; box-sizing: border-box;
                            ">
                            <input type="password" id="registerPassword" placeholder="Choose Password" style="
                                width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #555;
                                border-radius: 5px; background: #1a1a2e; color: #e0e0e0; box-sizing: border-box;
                            ">
                            <input type="password" id="confirmPassword" placeholder="Confirm Password" style="
                                width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #555;
                                border-radius: 5px; background: #1a1a2e; color: #e0e0e0; box-sizing: border-box;
                            ">
                            <button onclick="attemptRegister()" style="
                                width: 100%; padding: 12px; background: linear-gradient(45deg, #64ffda, #00bcd4);
                                color: #1a1a2e; border: none; border-radius: 5px; font-weight: bold; cursor: pointer;
                                margin-bottom: 10px;
                            ">Create Account</button>
                            <button onclick="showLoginForm()" style="
                                width: 100%; padding: 10px; background: transparent; color: #64ffda;
                                border: 1px solid #64ffda; border-radius: 5px; cursor: pointer;
                            ">Back to Login</button>
                        </div>

                        <div id="authMessage" style="
                            margin-top: 15px; text-align: center; font-size: 14px;
                        "></div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);

            return new Promise((resolve) => {
                window.authResolve = resolve;
            });
        }

        function showLoginForm() {
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('registerForm').style.display = 'none';
            clearAuthMessage();
        }

        function showRegisterForm() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'block';
            clearAuthMessage();
        }

        function clearAuthMessage() {
            document.getElementById('authMessage').innerHTML = '';
        }

        function showAuthMessage(message, isError = false) {
            const messageDiv = document.getElementById('authMessage');
            messageDiv.innerHTML = message;
            messageDiv.style.color = isError ? '#ff6b6b' : '#64ffda';
        }

        async function attemptLogin() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;

            if (!username || !password) {
                showAuthMessage('Please enter username and password', true);
                return;
            }

            try {
                showAuthMessage('Logging in...', false);
                const user = await authenticateUser(username, password);
                
                if (user) {
                    currentUser = user;
                    sessionStorage.setItem('currentUser', JSON.stringify(user));
                    document.getElementById('authModal').remove();
                    updateUserInterface();
                    
                    // Immediately load the user's specific data
                    await loadData();
                    updateAllCharts();
                    updateAllStats();
                    updateHistory();
                    
                    window.authResolve(true);
                } else {
                    showAuthMessage('Invalid username or password', true);
                }
            } catch (error) {
                console.error('Login error:', error);
                showAuthMessage('Login failed. Please try again.', true);
            }
        }

        async function attemptRegister() {
            const username = document.getElementById('registerUsername').value.trim();
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (!username || !password || !confirmPassword) {
                showAuthMessage('Please fill in all fields', true);
                return;
            }

            if (password !== confirmPassword) {
                showAuthMessage('Passwords do not match', true);
                return;
            }

            if (password.length < 6) {
                showAuthMessage('Password must be at least 6 characters', true);
                return;
            }

            try {
                showAuthMessage('Creating account...', false);
                const success = await registerUser(username, password);
                
                if (success) {
                    showAuthMessage('Account created! Please login.', false);
                    setTimeout(() => {
                        showLoginForm();
                        document.getElementById('loginUsername').value = username;
                    }, 1500);
                } else {
                    showAuthMessage('Username already exists', true);
                }
            } catch (error) {
                console.error('Registration error:', error);
                showAuthMessage('Registration failed. Please try again.', true);
            }
        }

        // Hash password function (simple for demo - use proper hashing in production)
        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password + 'salt123'); // Add salt
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // Authenticate user with database
        async function authenticateUser(username, password) {
            if (!dynamodb) {
                throw new Error('Database not initialized');
            }

            try {
                const hashedPassword = await hashPassword(password);
                
                const params = {
                    TableName: AWS_CONFIG.usersTableName,
                    Key: {
                        username: username
                    }
                };

                const result = await dynamodb.get(params).promise();
                
                if (result.Item && result.Item.password === hashedPassword) {
                    return {
                        username: result.Item.username,
                        createdAt: result.Item.created_at
                    };
                }
                
                return null;
            } catch (error) {
                console.error('Authentication error:', error);
                throw error;
            }
        }

        // Register new user in database
        async function registerUser(username, password) {
            if (!dynamodb) {
                throw new Error('Database not initialized');
            }

            try {
                // Check if user already exists
                const existingUserParams = {
                    TableName: AWS_CONFIG.usersTableName,
                    Key: {
                        username: username
                    }
                };

                const existingUser = await dynamodb.get(existingUserParams).promise();
                
                if (existingUser.Item) {
                    return false; // User already exists
                }

                // Hash password and create user
                const hashedPassword = await hashPassword(password);
                
                const createUserParams = {
                    TableName: AWS_CONFIG.usersTableName,
                    Item: {
                        username: username,
                        password: hashedPassword,
                        created_at: new Date().toISOString()
                    }
                };

                await dynamodb.put(createUserParams).promise();
                return true;
                
            } catch (error) {
                console.error('Registration error:', error);
                throw error;
            }
        }

        // Logout function
        function logout() {
            currentUser = null;
            sessionStorage.removeItem('currentUser');
            localStorage.removeItem('workout_form_data'); // Clear user's form data
            
            // Clear workouts from memory completely
            workouts = [];
            
            // Hide user info and reload page to force re-authentication
            document.getElementById('userInfo').style.display = 'none';
            location.reload();
        }

        // Update UI to show current user
        function updateUserInterface() {
            if (currentUser) {
                document.getElementById('currentUsername').textContent = currentUser.username;
                document.getElementById('userInfo').style.display = 'flex';
            } else {
                document.getElementById('userInfo').style.display = 'none';
            }
        }

        // Simple test function for mobile debugging
        async function testMobileConnection() {
            console.log('🧪 Starting mobile connection test...');
            const functionUrl = window.APP_CONFIG?.claudeLambdaUrl;
            
            if (!functionUrl) {
                console.error('❌ No Lambda URL configured');
                alert('No Lambda URL configured in config.js');
                return;
            }
            
            // Test 1: Direct Lambda
            try {
                console.log('🔗 Testing direct Lambda connection to:', functionUrl);
                const response = await fetch(functionUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: 'test', apiKey: 'test' })
                });
                
                console.log('✅ Lambda test response:', response.status, response.statusText);
                const text = await response.text();
                console.log('📄 Lambda response body:', text);
                alert(`Lambda direct: SUCCESS ${response.status} - ${text.substring(0, 50)}`);
                return;
            } catch (error) {
                console.error('❌ Lambda test failed:', error);
                
                // Test 2: Netlify Function Fallback
                try {
                    console.log('🔄 Testing Netlify function fallback...');
                    const netlifyResponse = await fetch('/.netlify/functions/claude-proxy', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            prompt: 'test', 
                            apiKey: 'test',
                            lambdaUrl: functionUrl
                        })
                    });
                    
                    console.log('✅ Netlify test response:', netlifyResponse.status, netlifyResponse.statusText);
                    const netlifyText = await netlifyResponse.text();
                    console.log('📄 Netlify response body:', netlifyText);
                    alert(`Lambda failed (${error.message.substring(0, 30)}) but Netlify proxy: SUCCESS ${netlifyResponse.status}`);
                } catch (netlifyError) {
                    console.error('❌ Both tests failed:', netlifyError);
                    alert(`Both failed - Lambda: ${error.message.substring(0, 30)}, Netlify: ${netlifyError.message.substring(0, 30)}`);
                }
            }
        }

        // Test Lambda connectivity
        async function testLambdaConnectivity() {
            const functionUrl = window.APP_CONFIG?.claudeLambdaUrl;
            
            if (!functionUrl) {
                console.error('Lambda URL not configured');
                return false;
            }
            
            try {
                // Mobile-optimized connectivity test
                const testOptions = {
                    method: 'POST',
                    mode: 'cors',
                    cache: 'no-cache',
                    credentials: 'omit',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ 
                        prompt: 'connectivity_test', 
                        apiKey: 'test_key' 
                    })
                };

                // 10 second timeout for connectivity test
                const fetchPromise = fetch(functionUrl, testOptions);
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('Connectivity test timeout')), 10000)
                );
                
                const response = await Promise.race([fetchPromise, timeoutPromise]);
                
                // Even if the response is an error (401 for bad API key), 
                // the connection to Lambda is working
                return response.status !== 0 && response.status < 500;
            } catch (error) {
                console.error('AWS Lambda connectivity test failed:', error);
                return false;
            }
        }

        // AI Recommendations using Anthropic SDK
        async function getAIRecommendations(exerciseNumber) {
            const dropdown = document.getElementById('workoutExercises' + exerciseNumber);
            const loadingSpan = document.getElementById('ai-loading-' + exerciseNumber);
            const recommendationsDiv = document.getElementById('ai-recommendations-' + exerciseNumber);
            
            if (!dropdown || !dropdown.value) {
                alert('Please select an exercise first');
                return;
            }
            
            const selectedExercise = dropdown.value;
            const exerciseData = exercises.find(ex => ex.key === selectedExercise);
            
            // Show loading state
            loadingSpan.style.display = 'inline';
            recommendationsDiv.style.display = 'none';
            
            try {
                // Quick connectivity test for mobile
                if (!(await testLambdaConnectivity())) {
                    throw new Error('Failed to fetch - Cannot reach Lambda server. Check network connection.');
                }
                // Get historical data for this exercise
                const exerciseHistory = workouts
                    .filter(w => w.exercise === selectedExercise)
                    .sort((a, b) => new Date(a.date) - new Date(b.date));
                
                if (exerciseHistory.length === 0) {
                    throw new Error('No historical data found for this exercise');
                }
                
                // Call Claude API using the SDK
                const recommendations = await callClaudeAPI(exerciseData, exerciseHistory);
                
                // Display recommendations
                displayAIRecommendations(exerciseNumber, recommendations);
                
            } catch (error) {
                console.error('AI recommendation error:', error);
                
                // Enhanced error handling for mobile debugging
                let errorMessage = error.message || 'Unable to get AI recommendations. Please try again.';
                let troubleshooting = '';
                
                if (error.message && (error.message.includes('Failed to fetch') || error.message.includes('Network connection failed'))) {
                    errorMessage = 'Network connection failed';
                    troubleshooting = `
                        <div style="margin-top: 8px; font-size: 11px; color: #ffa726;">
                            <strong>Troubleshooting:</strong><br>
                            • Check your internet connection<br>
                            • Try switching between WiFi and mobile data<br>
                            • Refresh the page and try again<br>
                            • If the issue persists, the Lambda function may be down
                        </div>
                    `;
                } else if (error.message && error.message.includes('timeout')) {
                    errorMessage = 'Request timed out';
                    troubleshooting = `
                        <div style="margin-top: 8px; font-size: 11px; color: #ffa726;">
                            <strong>Troubleshooting:</strong><br>
                            • Your connection may be slow<br>
                            • Try again with a better internet connection<br>
                            • The server may be experiencing high load
                        </div>
                    `;
                } else if (error.message && error.message.includes('Lambda URL not configured')) {
                    errorMessage = 'AI service not configured';
                    troubleshooting = `
                        <div style="margin-top: 8px; font-size: 11px; color: #ffa726;">
                            Lambda function URL needs to be configured in config.js
                        </div>
                    `;
                }
                
                recommendationsDiv.innerHTML = `
                    <div style="background: #2d2d44; padding: 15px; border-radius: 8px; border-left: 4px solid #ff6b6b;">
                        <h4 style="margin: 0 0 10px 0; font-size: 14px; color: #ff6b6b;">❌ AI Recommendation Error</h4>
                        <p style="margin: 0; font-size: 12px;">
                        ${errorMessage}
                        </p>
                        ${troubleshooting}
                        <button onclick="closeAIRecommendations(${exerciseNumber})" style="margin-top: 10px; background: #555; color: white; border: none; padding: 4px 8px; border-radius: 3px; font-size: 11px; cursor: pointer;">Close</button>
                    </div>
                `;
                
                recommendationsDiv.style.display = 'block';
            } finally {
                loadingSpan.style.display = 'none';
            }
        }

        async function callClaudeAPI(exerciseData, exerciseHistory) {
            const CLAUDE_API_KEY = window.APP_CONFIG?.claudeApiKey;
            
            if (!CLAUDE_API_KEY) {
                throw new Error('No Claude API key configured');
            }

            const lastWorkout = exerciseHistory[exerciseHistory.length - 1];
            const progressTrend = exerciseHistory.length >= 3 ? 
                exerciseHistory.slice(-3).map(w => Math.max(...w.sets.map(s => s.weight))) : [];
            
            const prompt = `You are an expert powerlifting coach. Analyze this workout data and provide ONLY a JSON response with specific weight and rep recommendations.

Exercise: ${exerciseData.displayName}
Primary Muscles: ${exerciseData.primaryMuscles.join(', ')}
Secondary Muscles: ${exerciseData.secondaryMuscles.join(', ')}

Last workout sets: ${JSON.stringify(lastWorkout.sets)}
Last 3 workout max weights: ${JSON.stringify(progressTrend)}
Total workouts recorded: ${exerciseHistory.length}

IMPORTANT REQUIREMENTS:
- Use REVERSE PYRAMID training (heaviest set first, then decrease weight)
- ALL weights must be in 2.5lb increments only (e.g., 135, 137.5, 140, 142.5, etc.)
- Suggest 3-4 sets maximum
- Consider if user has plateaued and needs deload or volume changes
- Factor in progressive overload but be conservative

Provide response as JSON only:
{
  "sets": [{"weight": 185, "reps": 5}, {"weight": 175, "reps": 6}, {"weight": 165, "reps": 8}],
  "notes": "Brief explanation of the programming choice"
}`;

            // Call AWS Lambda function
            const functionUrl = window.APP_CONFIG?.claudeLambdaUrl;
            
            if (!functionUrl) {
                throw new Error('Lambda URL not configured in config.js');
            }
            
            console.log('🔗 Calling AWS Lambda function...', functionUrl);
            console.log('📱 User Agent:', navigator.userAgent);
            console.log('🌐 Online status:', navigator.onLine);
            console.log('📍 Location protocol:', window.location.protocol);
            console.log('🔑 API Key configured:', !!CLAUDE_API_KEY);
            console.log('📝 Prompt length:', prompt.length);
            
            // Mobile-optimized fetch with proper error handling
            const fetchOptions = {
                method: 'POST',
                mode: 'cors',
                cache: 'no-cache',
                credentials: 'omit',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify({
                    prompt: prompt,
                    apiKey: CLAUDE_API_KEY
                })
            };

            let response;
            try {
                console.log('🚀 Starting fetch request to Lambda...');
                console.log('📦 Fetch options:', JSON.stringify(fetchOptions, null, 2));
                
                // Use Promise.race for timeout that works on all mobile browsers
                const fetchPromise = fetch(functionUrl, fetchOptions);
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('Request timeout after 30 seconds')), 30000)
                );
                
                console.log('⏱️ Waiting for response...');
                response = await Promise.race([fetchPromise, timeoutPromise]);
                console.log('✅ Response received:', response.status, response.statusText);
                console.log('📋 Response headers:', [...response.headers.entries()]);
            } catch (fetchError) {
                console.error('❌ Lambda fetch failed, trying Netlify fallback:', {
                    name: fetchError.name,
                    message: fetchError.message
                });
                
                // Fallback to Netlify function for mobile browsers
                console.log('🔄 Trying Netlify function fallback...');
                try {
                    const netlifyFetchOptions = {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            prompt: prompt,
                            apiKey: CLAUDE_API_KEY,
                            lambdaUrl: functionUrl // Tell Netlify function to proxy to Lambda
                        })
                    };
                    
                    const netlifyPromise = fetch('/.netlify/functions/claude-proxy', netlifyFetchOptions);
                    const netlifyTimeoutPromise = new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('Netlify request timeout after 30 seconds')), 30000)
                    );
                    
                    response = await Promise.race([netlifyPromise, netlifyTimeoutPromise]);
                    console.log('✅ Netlify fallback successful:', response.status, response.statusText);
                } catch (netlifyError) {
                    console.error('❌ Netlify fallback also failed:', netlifyError);
                    
                    // If both fail, provide helpful error message
                    if (fetchError.message.includes('timeout') || netlifyError.message.includes('timeout')) {
                        throw new Error('Request timed out - please try again');
                    }
                    
                    if (fetchError.name === 'TypeError' || fetchError.message.includes('Failed to fetch') || 
                        fetchError.message.includes('Load failed')) {
                        throw new Error('Network connection failed - your device may be blocking external requests');
                    }
                    
                    throw new Error('Connection failed - please check your internet connection');
                }
            }

            if (!response.ok) {
                let errorData;
                try {
                    errorData = await response.json();
                } catch (parseError) {
                    console.error('Failed to parse error response:', parseError);
                    errorData = {};
                }
                
                let errorMessage = errorData.error || `Lambda function error: ${response.status}`;
                
                // Add mobile-specific error context
                if (errorData.mobile_debug) {
                    console.log('Mobile debug info:', errorData.mobile_debug);
                }
                
                // Enhanced mobile error messages with better context
                if (response.status === 0 || response.status === 503) {
                    errorMessage = 'Network connection failed - check your internet connection and try again';
                } else if (response.status === 504) {
                    errorMessage = 'Request timed out - the server took too long to respond';
                } else if (response.status === 401) {
                    errorMessage = 'API authentication failed - invalid API key';
                } else if (response.status === 429) {
                    errorMessage = 'Rate limit exceeded - please wait a moment before trying again';
                } else if (response.status >= 500) {
                    errorMessage = 'Server error - please try again in a few minutes';
                }
                
                throw new Error(errorMessage);
            }

            const data = await response.json();
            console.log('✅ AWS Lambda function successful!');
            
            // Parse the response
            const responseText = data.content[0].text;
            console.log('📝 Claude response:', responseText);
            
            // Extract JSON from response
            const jsonMatch = responseText.match(/\{[\s\S]*\}/);
            if (jsonMatch) {
                const recommendations = JSON.parse(jsonMatch[0]);
                
                // Ensure weights are in 2.5lb increments
                recommendations.sets = recommendations.sets.map(set => ({
                    weight: Math.round(set.weight / 2.5) * 2.5,
                    reps: set.reps
                }));
                
                return recommendations;
            } else {
                throw new Error('No valid JSON found in AI response');
            }
        }

        function displayAIRecommendations(exerciseNumber, recommendations) {
            const recommendationsDiv = document.getElementById('ai-recommendations-' + exerciseNumber);
            
            const setsHtml = recommendations.sets.map((set, index) => 
                `<div style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px; font-size: 12px;">
                    <span style="min-width: 40px;">Set ${index + 1}:</span>
                    <span style="min-width: 60px; font-weight: bold;">${set.weight}lbs</span>
                    <span style="min-width: 40px;">× ${set.reps} reps</span>
                    <button onclick="applyAISet(${exerciseNumber}, ${index}, ${set.weight}, ${set.reps})" style="background: #64ffda; color: #1a1a2e; border: none; padding: 4px 8px; border-radius: 3px; font-size: 11px; cursor: pointer;">Apply</button>
                </div>`
            ).join('');
            
            recommendationsDiv.innerHTML = `
                <div style="background: #2d2d44; padding: 15px; border-radius: 8px; border-left: 4px solid #64ffda;">
                    <h4 style="color: #64ffda; margin: 0 0 10px 0; font-size: 14px;">🤖 AI Recommendations</h4>
                    ${setsHtml}
                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #444; font-size: 11px; color: #ccc;">
                        <strong>Notes:</strong> ${recommendations.notes}
                    </div>
                    <div style="margin-top: 10px; display: flex; gap: 8px;">
                        <button onclick="getAIRecommendations(${exerciseNumber})" style="background: #555; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 12px; cursor: pointer;">🔄 Regenerate</button>
                    </div>
                    <button onclick="closeAIRecommendations(${exerciseNumber})" style="margin-top: 10px; background: #555; color: white; border: none; padding: 4px 8px; border-radius: 3px; font-size: 11px; cursor: pointer;">Close</button>
                </div>
            `;
            
            recommendationsDiv.style.display = 'block';
        }

        function applyAISet(exerciseNumber, setIndex, weight, reps) {
            const setInputs = document.querySelectorAll(`#exercise-sets-${exerciseNumber} .set-input`);
            
            if (setInputs[setIndex]) {
                const weightInput = setInputs[setIndex].querySelector('input[placeholder="Weight"]');
                const repsInput = setInputs[setIndex].querySelector('input[placeholder="Reps"]');
                
                if (weightInput && repsInput) {
                    weightInput.value = weight;
                    repsInput.value = reps;
                    
                    // Save form data after applying AI recommendation
                    saveFormData();
                    
                    console.log(`Applied AI recommendation: Set ${setIndex + 1} - ${weight}lbs × ${reps} reps`);
                }
            }
        }

        function closeAIRecommendations(exerciseNumber) {
            const recommendationsDiv = document.getElementById('ai-recommendations-' + exerciseNumber);
            if (recommendationsDiv) {
                recommendationsDiv.style.display = 'none';
            }
        }

        // Save form inputs to localStorage
        function saveFormInputs() {
            var formData = {
                date: document.getElementById('day1-date').value,
                exercises: []
            };
            
            var allSetsContainers = document.querySelectorAll('.sets-container');
            allSetsContainers.forEach(function(container, index) {
                var exerciseNumber = index + 1;
                var dropdown = document.getElementById('workoutExercises' + exerciseNumber);
                var exerciseData = {
                    selectedExercise: dropdown ? dropdown.value : '',
                    sets: []
                };
                
                var inputs = container.querySelectorAll('input');
                for (var i = 0; i < inputs.length; i += 2) {
                    if (inputs[i] && inputs[i + 1]) {
                        exerciseData.sets.push({
                            weight: inputs[i].value,
                            reps: inputs[i + 1].value
                        });
                    }
                }
                
                formData.exercises.push(exerciseData);
            });
            
            localStorage.setItem('workout_form_data', JSON.stringify(formData));
        }

        // Restore form inputs from localStorage
        function restoreFormInputs() {
            var savedData = localStorage.getItem('workout_form_data');
            if (!savedData) return;
            
            try {
                var formData = JSON.parse(savedData);
                
                // Restore date
                if (formData.date) {
                    document.getElementById('day1-date').value = formData.date;
                }
                
                // Restore exercises
                formData.exercises.forEach(function(exerciseData, index) {
                    var exerciseNumber = index + 1;
                    
                    // Create additional exercises if needed
                    while (document.querySelectorAll('.sets-container').length < exerciseNumber) {
                        addExerciseToContainer('workout-input-1');
                    }
                    
                    // Set dropdown value
                    var dropdown = document.getElementById('workoutExercises' + exerciseNumber);
                    if (dropdown && exerciseData.selectedExercise) {
                        dropdown.value = exerciseData.selectedExercise;
                        updateRepRanges(exerciseNumber);
                        updateExerciseHistory(exerciseNumber);
                    }
                    
                    // Restore sets
                    var container = document.querySelectorAll('.sets-container')[index];
                    if (container && exerciseData.sets) {
                        var inputs = container.querySelectorAll('input');
                        
                        exerciseData.sets.forEach(function(setData, setIndex) {
                            var weightInput = inputs[setIndex * 2];
                            var repsInput = inputs[setIndex * 2 + 1];
                            
                            if (weightInput && setData.weight) {
                                weightInput.value = setData.weight;
                            }
                            if (repsInput && setData.reps) {
                                repsInput.value = setData.reps;
                            }
                        });
                    }
                });
                
            } catch (error) {
                console.error('Error restoring form data:', error);
            }
        }

        // Clear saved form data
        function clearSavedFormData() {
            localStorage.removeItem('workout_form_data');
        }

        // Auto-save form inputs when they change
        function setupAutoSave() {
            document.addEventListener('input', function(e) {
                if (e.target.type === 'number' || e.target.type === 'date') {
                    saveFormInputs();
                }
            });
            
            document.addEventListener('change', function(e) {
                if (e.target.tagName === 'SELECT') {
                    saveFormInputs();
                }
            });
        }

        // Load data from memory on page load
        window.onload = async function() {
            // Initialize AWS SDK first to ensure migration happens
            await initializeAWS();
            
            // Check authentication after AWS is initialized
            if (!(await checkAuthentication())) {
                return;
            }
            
            // Update UI to show logged in user
            updateUserInterface();
            
            
            await loadData();
            loadChartExercisesDropdown();
            loadWorkoutExercisesDropdown(1);
            updateAllCharts();
            updateAllStats();
            updateHistory();
            
            // Setup form persistence
            setupAutoSave();
            restoreFormInputs();
        };

        // Save data to DynamoDB or memory
        async function saveData() {
            if (USE_DATABASE) {
                // Save all workouts to DynamoDB
                for (let workout of workouts) {
                    await saveWorkoutToDatabase(workout);
                }
            } else {
                // Fallback to localStorage for demo
                window.appData = {
                    workouts: workouts,
                    exercises: exercises
                };
            }
        }

        // Load data from DynamoDB or memory
        async function loadData() {
            // Always clear workouts array first to ensure clean slate for each user
            workouts = [];
            
            if (USE_DATABASE) {
                try {
                    const loadedWorkouts = await loadWorkoutsFromDatabase();
                    console.log(`Loaded ${loadedWorkouts ? loadedWorkouts.length : 0} workouts from database for user: ${currentUser ? currentUser.username : 'unknown'}`);
                    if (loadedWorkouts && loadedWorkouts.length > 0) {
                        workouts = loadedWorkouts;
                        console.log('Using database workouts');
                    } else {
                        console.log('No database workouts found, starting with empty data');
                        // For new users, start with empty workouts array
                        workouts = [];
                    }
                } catch (error) {
                    console.error('Error loading from database:', error);
                    console.log('Starting with empty data due to error');
                    workouts = [];
                }
            } else {
                console.log('Database not configured, using sample data');
                // Fallback to localStorage
                if (window.appData) {
                    workouts = window.appData.workouts || [];
                    exercises = window.appData.exercises || exercises;
                }
            }
            console.log(`Final workouts array has ${workouts.length} entries for user: ${currentUser ? currentUser.username : 'unknown'}`);
        }

        // Save individual workout to DynamoDB
        async function saveWorkoutToDatabase(workout) {
            if (!dynamodb) {
                throw new Error('Database not initialized');
            }
            
            if (!currentUser) {
                throw new Error('No user logged in');
            }
            
            const params = {
                TableName: AWS_CONFIG.tableName,
                Item: {
                    user_id: currentUser.username,
                    workout_id: `${workout.exercise}#${workout.date}#${Date.now()}`,
                    exercise: workout.exercise,
                    date: workout.date,
                    sets: workout.sets,
                    created_at: new Date().toISOString()
                }
            };

            return dynamodb.put(params).promise();
        }

        // Load all workouts from DynamoDB
        async function loadWorkoutsFromDatabase() {
            if (!dynamodb) {
                throw new Error('Database not initialized');
            }
            
            if (!currentUser) {
                throw new Error('No user logged in');
            }
            
            const params = {
                TableName: AWS_CONFIG.tableName,
                KeyConditionExpression: 'user_id = :user_id',
                ExpressionAttributeValues: {
                    ':user_id': currentUser.username
                }
            };

            const result = await dynamodb.query(params).promise();
            return result.Items.map(item => ({
                exercise: item.exercise,
                date: item.date,
                sets: item.sets
            }));
        }

        function calculate1RM(weight, reps) {
            return Math.round(weight * (1 + reps / 30));
        }

        function create1RMChart(canvasId, exercise, color) {
            var canvas = document.getElementById(canvasId);
            if (!canvas) return;
            
            if (charts[canvasId]) {
                charts[canvasId].destroy();
                delete charts[canvasId];
            }
            
            data = workouts.filter(it => it.exercise == exercise)
                .sort((a, b) => new Date(a.date) - new Date(b.date));

            if (data.length === 0) {
                canvas.style.display = 'none';
                return;
            }
            
            canvas.style.display = 'block';
            
            var estimated1RMs = data.map(function(session) {
                var maxWeight = Math.max.apply(Math, session.sets.map(function(set) {
                    return calculate1RM(set.weight, set.reps);
                }));
                return maxWeight;
            });
            
            var dates = data.map(function(session) {
                return new Date(session.date).toLocaleDateString();
            });
            
            var ctx = canvas.getContext('2d');
            charts[canvasId] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        data: estimated1RMs,
                        borderColor: color,
                        backgroundColor: color + '20',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.2,
                        pointBackgroundColor: color,
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: { display: true, text: 'Estimated 1RM (lbs)' }
                        }
                    }
                }
            });
        }

        function createVolumeChart(canvasId, exercise, color) {
            var canvas = document.getElementById(canvasId);
            if (!canvas) return;
            
            if (charts[canvasId]) {
                charts[canvasId].destroy();
                delete charts[canvasId];
            }
            
            data = workouts.filter(it => it.exercise == exercise)
                .sort((a, b) => new Date(a.date) - new Date(b.date));

            if (data.length === 0) {
                canvas.style.display = 'none';
                return;
            }
            
            canvas.style.display = 'block';
            
            var volumes = data.map(function(session) {
                return session.sets.reduce(function(total, set) {
                    return total + (set.weight * set.reps);
                }, 0);
            });
            
            var dates = data.map(function(session) {
                return new Date(session.date).toLocaleDateString();
            });
            
            var ctx = canvas.getContext('2d');
            charts[canvasId] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: dates,
                    datasets: [{
                        data: volumes,
                        backgroundColor: color + '80',
                        borderColor: color,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Volume (lbs)' }
                        }
                    }
                }
            });
        }

        function updateAllCharts() {
            create1RMChart('deadlift1RMChart', 'deadlift', '#e74c3c');
            createVolumeChart('deadliftVolumeChart', 'deadlift', '#e74c3c');
        }

        function updateStats(exercise) {
            var data = workouts.filter(it => it.exercise == exercise)
                .sort((a, b) => new Date(a.date) - new Date(b.date));
            if (!data || data.length === 0) return;
            
            var currentMax = Math.max.apply(Math, data.map(function(session) {
                return Math.max.apply(Math, session.sets.map(function(set) {
                    return calculate1RM(set.weight, set.reps);
                }));
            }));
            
            var firstMax = Math.max.apply(Math, data[0].sets.map(function(set) {
                return calculate1RM(set.weight, set.reps);
            }));
            
            var totalGain = currentMax - firstMax;
            
            document.getElementById('current-max').textContent = currentMax;
            document.getElementById('total-gain').textContent = (totalGain >= 0 ? '+' : '') + totalGain;
            document.getElementById('sessions').textContent = data.length;
        }

        function updateAllStats() {
            updateStats('deadlift');
        }

        // Add set function
        function addSetToContainer(containerId) {
            var container = document.getElementById(containerId);
            if (!container) return;
            
            var setNumber = container.children.length + 1;
            var newSet = document.createElement('div');
            newSet.className = 'set-input';
            newSet.innerHTML = 
                '<input type="number" inputmode="numeric" pattern="[0-9]*" placeholder="Weight" />' +
                '<span>&times;</span>' +
                '<input type="number" inputmode="numeric" pattern="[0-9]*" placeholder="Reps" />' +
                '<button class="btn" onclick="this.parentElement.remove()" style="padding: 4px 8px; margin-left: 8px;">&times;</button>';
            container.appendChild(newSet);
        }

        function addExerciseToContainer(containerId) {
            var container = document.getElementById(containerId);
            if (!container) return;
            
            var exerciseNumber = container.children.length + 1;
            var newExercise = document.createElement('div');

            var id = 'exercise-sets-' + exerciseNumber
            newExercise.className = 'exercise-input'
            
            // Add delete button for exercises after the first one
            var deleteButtonHtml = exerciseNumber > 1 ? 
                '<button class="btn" onclick="deleteExercise(this);" style="background: #e74c3c; margin-left: 10px; padding: 4px 8px;">Delete Exercise</button>' : '';
            
            newExercise.innerHTML = 
                '<div style="display: flex; align-items: center; margin-bottom: 10px;">' +
                    '<div class="exercise-title" id="exercise-title-workout-' + exerciseNumber + '"></div>' +
                    deleteButtonHtml +
                '</div>' +
                '<div id="rep-ranges-' + exerciseNumber + '" style="margin-bottom: 10px; font-size: 14px; color: #b0b0b0; font-style: italic;"></div>' +
                '<div id="exercise-history-' + exerciseNumber + '" style="margin-bottom: 15px;"></div>' +
                '<div style="margin-bottom: 10px;">' +
                    '<button class="btn" onclick="getAIRecommendations(' + exerciseNumber + ')" style="background: linear-gradient(45deg, #ff6b6b, #ffa726); color: white; font-size: 12px; padding: 6px 12px;">🤖 AI Recommendations</button>' +
                    '<span id="ai-loading-' + exerciseNumber + '" style="display: none; margin-left: 10px; color: #64ffda; font-size: 12px;">Analyzing your data...</span>' +
                '</div>' +
                '<div id="ai-recommendations-' + exerciseNumber + '" style="margin-bottom: 10px; display: none;"></div>' +
                '<div class="sets-container" id="' + id + '">' +
                    '<div class="set-input">' +
                        '<input type="number" inputmode="numeric" pattern="[0-9]*" placeholder="Weight" />' +
                        '<span>&times;</span>' +
                        '<input type="number" inputmode="numeric" pattern="[0-9]*" placeholder="Reps" />' +
                    '</div>' +
                    '<div class="set-input">' +
                        '<input type="number" inputmode="numeric" pattern="[0-9]*" placeholder="Weight" />' +
                        '<span>&times;</span>' +
                        '<input type="number" inputmode="numeric" pattern="[0-9]*" placeholder="Reps" />' +
                        '<button class="btn" onclick="this.parentElement.remove()" style="padding: 4px 8px; margin-left: 8px;">&times;</button>' +
                    '</div>' +
                    '<div class="set-input">' +
                        '<input type="number" inputmode="numeric" pattern="[0-9]*" placeholder="Weight" />' +
                        '<span>&times;</span>' +
                        '<input type="number" inputmode="numeric" pattern="[0-9]*" placeholder="Reps" />' +
                        '<button class="btn" onclick="this.parentElement.remove()" style="padding: 4px 8px; margin-left: 8px;">&times;</button>' +
                    '</div>' +
                '</div>' +
                '<button class="btn" onclick="addSetToContainer(\'' + id + '\')">+ Add Set</button>'
            container.appendChild(newExercise)
            loadWorkoutExercisesDropdown(exerciseNumber)
        }

        function loadWorkoutExercisesDropdown(exerciseNumber) {
            // Create select element using DOM methods for better Chrome compatibility
            const select = document.createElement('select');
            select.id = "workoutExercises" + exerciseNumber;
            select.onchange = function() { onExerciseChange(exerciseNumber); };
            
            // Add default option
            const defaultOption = document.createElement('option');
            defaultOption.value = "";
            defaultOption.textContent = "Select Exercise";
            select.appendChild(defaultOption);
            
            // Get already selected exercises to exclude them
            var selectedExercises = getSelectedExercises(exerciseNumber);
            
            exercises.forEach(exercise => {
                if (!selectedExercises.includes(exercise.key)) {
                    const option = document.createElement('option');
                    option.value = exercise.key;
                    option.textContent = exercise.displayName;
                    
                    // Auto-select deadlift for first exercise
                    if (exerciseNumber === 1 && exercise.key === 'deadlift') {
                        option.selected = true;
                    }
                    
                    select.appendChild(option);
                }
            });
            
            // Clear and append the new select element
            const container = document.getElementById("exercise-title-workout-" + exerciseNumber);
            container.innerHTML = "";
            container.appendChild(select);
            // Initialize rep ranges and history display
            setTimeout(() => {
                updateRepRanges(exerciseNumber);
                updateExerciseHistory(exerciseNumber);
            }, 0);
        }

        function getSelectedExercises(excludeExerciseNumber) {
            var selected = [];
            var container = document.getElementById('workout-input-1');
            if (!container) return selected;
            
            // Find all exercise dropdowns
            var dropdowns = container.querySelectorAll('select[id^="workoutExercises"]');
            dropdowns.forEach(function(dropdown) {
                // Extract exercise number from dropdown ID
                var dropdownNumber = parseInt(dropdown.id.replace('workoutExercises', ''));
                // Skip the dropdown we're currently updating
                if (dropdownNumber !== excludeExerciseNumber && dropdown.value) {
                    selected.push(dropdown.value);
                }
            });
            
            return selected;
        }

        function onExerciseChange(exerciseNumber) {
            updateRepRanges(exerciseNumber);
            updateExerciseHistory(exerciseNumber);
            refreshAllDropdowns();
        }

        function deleteExercise(button) {
            // Remove the exercise
            const exerciseInput = button.closest('.exercise-input');
            if (exerciseInput) {
                exerciseInput.remove();
                
                // Renumber remaining exercises and update IDs
                setTimeout(function() {
                    renumberExercises();
                    refreshAllDropdowns();
                    saveFormInputs(); // Save the updated form state
                }, 0);
            }
        }

        function renumberExercises() {
            const container = document.getElementById('workout-input-1');
            if (!container) return;
            
            const exercises = container.querySelectorAll('.exercise-input');
            
            exercises.forEach(function(exercise, index) {
                const newNumber = index + 1;
                
                // Update exercise title
                const titleDiv = exercise.querySelector('.exercise-title');
                if (titleDiv) {
                    titleDiv.id = `exercise-title-workout-${newNumber}`;
                }
                
                // Update rep ranges div
                const repRangesDiv = exercise.querySelector('[id^="rep-ranges-"]');
                if (repRangesDiv) {
                    repRangesDiv.id = `rep-ranges-${newNumber}`;
                }
                
                // Update exercise history div
                const historyDiv = exercise.querySelector('[id^="exercise-history-"]');
                if (historyDiv) {
                    historyDiv.id = `exercise-history-${newNumber}`;
                }
                
                // Update sets container
                const setsContainer = exercise.querySelector('.sets-container');
                if (setsContainer) {
                    setsContainer.id = `exercise-sets-${newNumber}`;
                }
                
                // Update dropdown
                const dropdown = exercise.querySelector('select');
                if (dropdown) {
                    dropdown.id = `workoutExercises${newNumber}`;
                    dropdown.onchange = function() {
                        updateRepRanges(newNumber);
                        updateExerciseHistory(newNumber);
                        saveFormInputs();
                    };
                }
            });
        }

        function refreshAllDropdowns() {
            var container = document.getElementById('workout-input-1');
            if (!container) return;
            
            // Find all exercise dropdowns and store their current values
            var dropdowns = container.querySelectorAll('select[id^="workoutExercises"]');
            var currentValues = {};
            
            dropdowns.forEach(function(dropdown) {
                var exerciseNumber = parseInt(dropdown.id.replace('workoutExercises', ''));
                currentValues[exerciseNumber] = dropdown.value;
            });
            
            // Refresh each dropdown while preserving selections
            dropdowns.forEach(function(dropdown) {
                var exerciseNumber = parseInt(dropdown.id.replace('workoutExercises', ''));
                var currentValue = currentValues[exerciseNumber];
                
                // Rebuild dropdown options using DOM methods for Chrome compatibility
                var selectedExercises = getSelectedExercises(exerciseNumber);
                
                // Clear existing options
                dropdown.innerHTML = "";
                
                // Add default option
                var defaultOption = document.createElement('option');
                defaultOption.value = "";
                defaultOption.textContent = "Select Exercise";
                dropdown.appendChild(defaultOption);
                
                // Add exercise options
                exercises.forEach(function(exercise) {
                    if (!selectedExercises.includes(exercise.key)) {
                        var option = document.createElement('option');
                        option.value = exercise.key;
                        option.textContent = exercise.displayName;
                        
                        if (exercise.key === currentValue) {
                            option.selected = true;
                        }
                        
                        dropdown.appendChild(option);
                    }
                });
            });
        }

        function updateRepRanges(exerciseNumber) {
            var dropdown = document.getElementById("workoutExercises" + exerciseNumber);
            var repRangesDiv = document.getElementById("rep-ranges-" + exerciseNumber);
            
            if (dropdown && repRangesDiv) {
                var selectedExercise = exercises.find(ex => ex.key === dropdown.value);
                if (selectedExercise) {
                    var primaryMuscles = selectedExercise.primaryMuscles.join(', ');
                    var secondaryMuscles = selectedExercise.secondaryMuscles.length > 0 
                        ? selectedExercise.secondaryMuscles.join(', ') 
                        : 'None';
                    
                    repRangesDiv.innerHTML = `
                        <div style="margin-bottom: 5px;">
                            <strong>Rep Range:</strong> ${selectedExercise.repRanges}
                        </div>
                        <div style="margin-bottom: 3px;">
                            <strong>Primary:</strong> <span style="color: #64ffda;">${primaryMuscles}</span>
                        </div>
                        <div>
                            <strong>Secondary:</strong> <span style="color: #ffa726;">${secondaryMuscles}</span>
                        </div>
                    `;
                } else {
                    repRangesDiv.innerHTML = "";
                }
            }
        }

        function updateExerciseHistory(exerciseNumber) {
            var dropdown = document.getElementById("workoutExercises" + exerciseNumber);
            var historyDiv = document.getElementById("exercise-history-" + exerciseNumber);
            
            if (!dropdown || !historyDiv || !dropdown.value) {
                if (historyDiv) historyDiv.innerHTML = "";
                return;
            }
            
            // Get last 5 workouts for this exercise in descending chronological order
            var exerciseWorkouts = workouts
                .filter(w => w.exercise === dropdown.value)
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 5);
            
            if (exerciseWorkouts.length === 0) {
                historyDiv.innerHTML = '<div style="font-size: 12px; color: #b0b0b0; font-style: italic;">No previous sessions</div>';
                return;
            }
            
            var html = '<div style="font-size: 12px; color: #b0b0b0; margin-bottom: 8px; font-weight: bold;">Recent Sessions:</div>';
            html += '<div style="background: #2a2a42; border-radius: 8px; padding: 10px; font-size: 12px; border: 1px solid #555;">';
            
            exerciseWorkouts.forEach(function(session, index) {
                if (index > 0) html += '<hr style="margin: 6px 0; border: none; border-top: 1px solid #555;">';
                
                html += '<div style="margin-bottom: 4px;">';
                html += '<span style="font-weight: bold; color: #64ffda;">' + new Date(session.date).toLocaleDateString() + ':</span> ';
                
                session.sets.forEach(function(set, setIndex) {
                    if (setIndex > 0) html += ', ';
                    html += '<span style="color: #e0e0e0;">' + set.weight + '×' + set.reps + '</span>';
                });
                
                html += '</div>';
            });
            
            html += '</div>';
            historyDiv.innerHTML = html;
        }

        function loadChartExercisesDropdown() {
            let text = "<select id=chartExercises onchange=\"updateChartsDropdown()\">"
            exercises.forEach(
                it => text += "<option value=\"" + it.key + "\">" + it.displayName + "</option>"
            )
            text += "</select>"
            document.getElementById("exercise-title-chart").innerHTML = text;
        }

        function updateChartsDropdown() {
            var x = document.getElementById("chartExercises").value;
            create1RMChart('deadlift1RMChart', x, '#e74c3c');
            createVolumeChart('deadliftVolumeChart', x, '#e74c3c');
            updateStats(x);
        }

        // Save session functions
        async function saveDay1Session() {
            var dateInput = document.getElementById('day1-date').value;
            var sessionDate = dateInput || new Date().toISOString().split('T')[0];
            
            var sessionSets = [].slice.call(document.getElementsByClassName('sets-container'))
            var sets = sessionSets.map(it => getSetsFromContainer(it))

            var areAllEmpty = sets.filter(s => s.length != 0).length == 0

            if (areAllEmpty) {
                alert('Please enter at least one set');
            } else {
                var newWorkouts = [];
                sets.forEach((setData, index) => {
                    if (setData.length > 0) {
                        var exerciseNumber = index + 1;
                        var exerciseContainer = sessionSets[index].closest('.exercise-input');
                        var exerciseDropdown = exerciseContainer.querySelector('select');
                        var exerciseName = exerciseDropdown ? exerciseDropdown.value : 'deadlift';
                        var newWorkout = {exercise: exerciseName, date: sessionDate, sets: setData};
                        workouts.push(newWorkout);
                        newWorkouts.push(newWorkout);
                    }
                });

                try {
                    if (USE_DATABASE) {
                        // Save only new workouts to database
                        for (let workout of newWorkouts) {
                            await saveWorkoutToDatabase(workout);
                        }
                    } else {
                        await saveData();
                    }
                    
                    updateAllCharts();
                    updateAllStats();
                    clearDay1Inputs();
                    clearSavedFormData();
                    alert('Session saved successfully!');
                } catch (error) {
                    console.error('Error saving session:', error);
                    alert('Error saving session. Please check your database configuration.');
                }
            }     
        }

        function getSetsFromContainer(container) {
            var sets = [];
            if (!container) return sets;
            
            for (var i = 0; i < container.children.length; i++) {
                var setInput = container.children[i];
                var inputs = setInput.querySelectorAll('input');
                if (inputs[0] && inputs[1] && inputs[0].value && inputs[1].value) {
                    sets.push({
                        weight: parseInt(inputs[0].value),
                        reps: parseInt(inputs[1].value)
                    });
                }
            }
            return sets;
        }

        function clearDay1Inputs() {
            document.getElementById('day1-date').value = '';
            
            // Clear all exercise containers
            var allSetsContainers = document.querySelectorAll('.sets-container');
            allSetsContainers.forEach(function(container) {
                var inputs = container.querySelectorAll('input');
                inputs.forEach(function(input) {
                    input.value = '';
                });
            });
            
            // Reset all exercise dropdowns to first option
            var allDropdowns = document.querySelectorAll('select[id^="workoutExercises"]');
            allDropdowns.forEach(function(dropdown) {
                if (dropdown.options.length > 0) {
                    dropdown.selectedIndex = 0;
                    // Trigger change event to update rep ranges and history
                    var exerciseNumber = parseInt(dropdown.id.replace('workoutExercises', ''));
                    updateRepRanges(exerciseNumber);
                    updateExerciseHistory(exerciseNumber);
                }
            });
        }

        // Data management functions
        function exportData() {
            var data = {
                workouts: workouts,
                exportDate: new Date().toISOString()
            };
            
            var dataStr = JSON.stringify(data, null, 2);
            var dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            var link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = 'lifting_progress_' + new Date().toISOString().split('T')[0] + '.json';
            link.click();
        }


        // History management functions
        function toggleHistory(day) {
            var historyDiv = document.getElementById('history');
            if (historyDiv.style.display === 'none') {
                historyDiv.style.display = 'block';
                updateHistory(day);
            } else {
                historyDiv.style.display = 'none';
            }
        }

        function updateHistory() {
            var historyDiv = document.getElementById('history');
                        
            var html = '';

            var w = workouts.sort((a, b) => a.date.localeCompare(b.date)).reverse();
            
            w.forEach(function(session, index) {
                var exercise = exercises.find(ex => ex.key === session.exercise);
                var displayName = exercise ? exercise.displayName : session.exercise;
                
                html += '<div class="history-entry">';
                html += '<div>';
                html += '<span class="history-date">' + displayName + " - " + new Date(session.date).toLocaleDateString() + '</span>';
                html += '<div class="history-sets">';
                session.sets.forEach(function(set, setIndex) {
                    if (setIndex > 0) html += ', ';
                    html += set.weight + ' × ' + set.reps;
                });
                html += '</div>';
                html += '</div>';
                html += '<button class="btn-delete" onclick="deleteSession(\'' + session.exercise.toLowerCase().replace(/\s+/g, '').replace('-', '') + '\', ' + index + ')">Delete</button>';
                html += '</div>';
            });
            
            if (html === '') {
                html = '<p style="color: #666; text-align: center;">No sessions recorded yet.</p>';
            }
            
            historyDiv.innerHTML = html;
        }


        function deleteSession(exerciseName, index) {
            if (confirm('Are you sure you want to delete this session?')) {

                if (workouts[index]) {
                    workouts[dataKey].splice(index, 1);
                    saveData();
                    updateAllCharts();
                    updateAllStats();
                    updateHistory();
                    alert('Session deleted successfully!');
                }
            
            }
        }
    </script>
</body>
</html>
                            